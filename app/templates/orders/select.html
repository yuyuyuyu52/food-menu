{% extends 'base.html' %}

{% block title %}点菜菜单 - 首页{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1>点菜菜单</h1>
        </div>
    </div>
</div>

{% if dishes %}
    <form action="{{ url_for('orders.review') }}" method="post">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
        
        <div class="row">
            <!-- 左侧导航栏 -->
            <div class="col-md-2">
                <div class="list-group sticky-top" style="top: 20px;">
                    <div class="list-group-item list-group-item-primary">菜品分类</div>
                    <a href="#all-dishes" class="list-group-item list-group-item-action">全部菜品</a>
                    {% for category in categories %}
                        <a href="#category-{{ category.id }}" class="list-group-item list-group-item-action">{{ category.name }}</a>
                    {% endfor %}
                </div>
            </div>
            
            <!-- 右侧菜品展示 -->
            <div class="col-md-10">
                <div id="all-dishes" class="mb-4">
                    <h3 class="border-bottom pb-2">全部菜品</h3>
                    
                    <div class="list-group">
                        {% for dish in dishes %}
                            <div class="list-group-item list-group-item-action d-flex align-items-center py-3">
                                <!-- 左侧图片 -->
                                <div class="me-3" style="width: 80px; height: 80px; overflow: hidden; flex-shrink: 0;">
                                    {% if dish.image_path %}
                                        <img src="{{ url_for('static', filename=dish.image_path) }}" alt="{{ dish.name }}" class="img-fluid" style="width: 100%; height: 100%; object-fit: cover;">
                                    {% else %}
                                        <div class="bg-light d-flex justify-content-center align-items-center h-100">
                                            <i class="fas fa-utensils fa-2x text-muted"></i>
                                        </div>
                                    {% endif %}
                                </div>
                                
                                <!-- 中间菜品信息 -->
                                <div class="flex-grow-1">
                                    <h5 class="mb-1">{{ dish.name }}</h5>
                                    <span class="badge bg-secondary me-2">{{ dish.category.name }}</span>
                                    <small class="text-muted">配料: {{ dish.ingredients|length }} 种</small>
                                </div>
                                
                                <!-- 右侧添加按钮 -->
                                <div class="form-check form-check-inline me-0">
                                    <input class="form-check-input dish-checkbox" type="checkbox" name="dish_ids" value="{{ dish.id }}" id="dish{{ dish.id }}" style="transform: scale(1.5);">
                                    <label class="form-check-label ms-2" for="dish{{ dish.id }}">
                                        <i class="fas fa-plus-circle text-primary" style="font-size: 1.5rem;"></i>
                                    </label>
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                </div>
                
                <!-- 按分类显示菜品 -->
                {% for category in categories %}
                    <div id="category-{{ category.id }}" class="mb-4">
                        <h3 class="border-bottom pb-2">{{ category.name }}</h3>
                        
                        <div class="list-group">
                            {% for dish in dishes if dish.category_id == category.id %}
                                <div class="list-group-item list-group-item-action d-flex align-items-center py-3">
                                    <!-- 左侧图片 -->
                                    <div class="me-3" style="width: 80px; height: 80px; overflow: hidden; flex-shrink: 0;">
                                        {% if dish.image_path %}
                                            <img src="{{ url_for('static', filename=dish.image_path) }}" alt="{{ dish.name }}" class="img-fluid" style="width: 100%; height: 100%; object-fit: cover;">
                                        {% else %}
                                            <div class="bg-light d-flex justify-content-center align-items-center h-100">
                                                <i class="fas fa-utensils fa-2x text-muted"></i>
                                            </div>
                                        {% endif %}
                                    </div>
                                    
                                    <!-- 中间菜品信息 -->
                                    <div class="flex-grow-1">
                                        <h5 class="mb-1">{{ dish.name }}</h5>
                                        <small class="text-muted">配料: {{ dish.ingredients|length }} 种</small>
                                    </div>
                                    
                                    <!-- 右侧添加按钮 -->
                                    <div class="form-check form-check-inline me-0">
                                        <input class="form-check-input dish-checkbox" type="checkbox" name="dish_ids" value="{{ dish.id }}" id="dish{{ dish.id }}_cat" style="transform: scale(1.5);">
                                        <label class="form-check-label ms-2" for="dish{{ dish.id }}_cat">
                                            <i class="fas fa-plus-circle text-primary" style="font-size: 1.5rem;"></i>
                                        </label>
                                    </div>
                                </div>
                            {% else %}
                                <div class="list-group-item">该分类下暂无菜品</div>
                            {% endfor %}
                        </div>
                    </div>
                {% endfor %}
            </div>
        </div>
        
        <div class="sticky-bottom bg-light py-3 border-top mt-4">
            <div class="container">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        已选择 <span id="selected-count" class="badge bg-primary">0</span> 个菜品
                    </div>
                    <button type="submit" class="btn btn-lg btn-primary">
                        <i class="fas fa-shopping-cart"></i> 继续下一步
                    </button>
                </div>
            </div>
        </div>
    </form>
{% else %}
    <div class="alert alert-info">
        <p>暂无菜品可供选择。请先创建一些菜品。</p>
        <a href="{{ url_for('dishes.create') }}" class="btn btn-primary">
            <i class="fas fa-plus"></i> 创建菜品
        </a>
    </div>
{% endif %}

{% endblock %}

{% block scripts %}
<script>
    // 同步勾选状态
    document.addEventListener('DOMContentLoaded', function() {
        // 获取所有菜品复选框
        const checkboxes = document.querySelectorAll('.dish-checkbox');
        const selectedCountElement = document.getElementById('selected-count');
        
        // 同步相同菜品的复选框
        function syncCheckboxes(clickedId, isChecked) {
            // 仅获取ID数字部分
            const dishId = clickedId.replace('dish', '').replace('_cat', '');
            
            // 同步所有相同菜品ID的复选框
            checkboxes.forEach(function(checkbox) {
                if (checkbox.id.includes('dish' + dishId)) {
                    checkbox.checked = isChecked;
                }
            });
            
            // 更新已选计数
            updateSelectedCount();
        }
        
        // 更新已选计数
        function updateSelectedCount() {
            // 使用Set去重
            const selectedIds = new Set();
            checkboxes.forEach(function(checkbox) {
                if (checkbox.checked) {
                    const dishId = checkbox.value;
                    selectedIds.add(dishId);
                }
            });
            
            selectedCountElement.textContent = selectedIds.size;
        }
        
        // 为所有复选框添加点击事件
        checkboxes.forEach(function(checkbox) {
            checkbox.addEventListener('change', function() {
                syncCheckboxes(this.id, this.checked);
            });
        });
        
        // 初始化计数
        updateSelectedCount();
        
        // 平滑滚动到锚点
        document.querySelectorAll('.list-group-item').forEach(anchor => {
            anchor.addEventListener('click', function(e) {
                const href = this.getAttribute('href');
                if (href && href.startsWith('#')) {
                    e.preventDefault();
                    const targetId = href.substring(1);
                    const targetElement = document.getElementById(targetId);
                    
                    if (targetElement) {
                        window.scrollTo({
                            top: targetElement.offsetTop - 20,
                            behavior: 'smooth'
                        });
                    }
                }
            });
        });
    });
</script>
{% endblock %}
