{% extends 'base.html' %}

{% block title %}点菜菜单 - 首页{% endblock %}

{% block header_title %}点菜{% endblock %}

{% block content %}
{% if dishes %}
    <form action="{{ url_for('orders.review') }}" method="post">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
        
        <div class="flex flex-row gap-0">
            <!-- 左侧分类导航栏 - 像美团/饿了么样式 -->
            <div class="w-1/4 sm:w-1/5 md:w-1/6 bg-gray-100 h-screen overflow-y-auto sticky top-0 px-0">
                <div class="py-2">
                    {% for category in categories %}
                        <a href="#category-{{ category.id }}" 
                           class="block py-3 px-2 border-l-4 text-center {% if loop.first %}border-blue-500 bg-white text-blue-600{% else %}border-transparent hover:border-blue-300 hover:bg-white text-gray-700 hover:text-blue-500{% endif %} transition duration-150">
                            <div class="text-sm">{{ category.name }}</div>
                        </a>
                    {% endfor %}
                </div>
            </div>
            
            <!-- 右侧菜品列表 -->
            <div class="w-3/4 sm:w-4/5 md:w-5/6 overflow-y-auto h-screen bg-white">
                <div class="p-2 sm:p-4">
                    {% for category in categories %}
                        <div id="category-{{ category.id }}" class="mb-6">
                            <h2 class="text-lg font-semibold text-gray-800 p-2 sticky top-0 bg-gray-100 z-10 rounded-md">{{ category.name }}</h2>
                            
                            <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 mt-2">
                                {% for dish in dishes if dish.category_id == category.id %}
                                    <div class="bg-white rounded-lg shadow-sm overflow-hidden border">
                                        <div class="p-3 flex items-start">
                                            <!-- 菜品图片 -->
                                            <div class="w-20 h-20 sm:w-24 sm:h-24 flex-shrink-0 rounded overflow-hidden mr-3 bg-gray-100">
                                                {% if dish.image_path %}
                                                    {% set image_path = dish.image_path %}
                                                    {% set thumb_path = image_path.replace(image_path.split('/')[-1], 'thumb_' + image_path.split('/')[-1]) %}
                                                    <img 
                                                        src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 1 1'%3E%3C/svg%3E" 
                                                        data-src="{{ url_for('static', filename=thumb_path) }}" 
                                                        alt="{{ dish.name }}" 
                                                        class="lazy-image w-full h-full object-cover">
                                                {% else %}
                                                    <div class="w-full h-full flex items-center justify-center">
                                                        <i class="fas fa-utensils text-gray-400 text-2xl"></i>
                                                    </div>
                                                {% endif %}
                                            </div>
                                            
                                            <!-- 菜品信息 -->
                                            <div class="flex-grow flex flex-col justify-between h-full">
                                                <div>
                                                    <h3 class="font-medium text-gray-900 mb-1">{{ dish.name }}</h3>
                                                    <p class="text-xs text-gray-500 mb-2">
                                                        配料: {{ dish.ingredients|length }}种
                                                    </p>
                                                </div>
                                                
                                                <!-- 点菜操作 -->
                                                <div class="flex justify-between items-center mt-1">
                                                    <div class="flex items-center">
                                                        <input type="checkbox" name="dish_ids" id="dish-{{ dish.id }}" value="{{ dish.id }}" class="form-checkbox">
                                                        <label for="dish-{{ dish.id }}" class="ml-2 text-sm text-blue-600 cursor-pointer">选择</label>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                {% endfor %}
                            </div>
                        </div>
                    {% endfor %}
                </div>
            </div>
        </div>
        
        <!-- 底部提交按钮 - 固定在底部 -->
        <div class="fixed bottom-16 right-0 left-0 p-3 bg-white shadow-lg border-t z-20">
            <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white py-2 rounded-md shadow-sm font-medium opacity-70 cursor-not-allowed" disabled>
                <i class="fas fa-check-circle mr-2"></i> 确认已选菜品 <span id="selected-count" class="inline-block ml-1 px-2 py-0.5 bg-white text-blue-700 rounded-full font-bold">0</span>
            </button>
        </div>
    </form>
{% else %}
    <div class="bg-blue-100 border-l-4 border-blue-500 text-blue-700 p-4 rounded">
        <p>暂无菜品可供选择，请先添加菜品。</p>
    </div>
{% endif %}
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // 获取所有分类链接和分类区域
        const categoryLinks = document.querySelectorAll('a[href^="#category-"]');
        
        // 添加点击事件，点击时高亮当前分类
        categoryLinks.forEach(link => {
            link.addEventListener('click', function(e) {
                // 移除所有链接的高亮样式
                categoryLinks.forEach(l => {
                    l.classList.remove('border-blue-500', 'bg-white', 'text-blue-600');
                    l.classList.add('border-transparent', 'text-gray-700');
                });
                
                // 给当前点击的链接添加高亮样式
                this.classList.remove('border-transparent', 'text-gray-700');
                this.classList.add('border-blue-500', 'bg-white', 'text-blue-600');
            });
        });
        
        // 滚动时检测当前可见的分类区域
        const categoryAreas = Array.from(document.querySelectorAll('[id^="category-"]'));
        const menuContainer = document.querySelector('.w-3\\/4.sm\\:w-4\\/5.md\\:w-5\\/6');
        
        if (menuContainer) {
            menuContainer.addEventListener('scroll', debounce(function() {
                let currentCategory = null;
                
                // 找到当前视图中的第一个分类
                for (const area of categoryAreas) {
                    const rect = area.getBoundingClientRect();
                    if (rect.top <= 100 && rect.bottom > 0) {
                        currentCategory = area.id;
                        break;
                    }
                }
                
                if (currentCategory) {
                    // 移除所有链接的高亮样式
                    categoryLinks.forEach(l => {
                        l.classList.remove('border-blue-500', 'bg-white', 'text-blue-600');
                        l.classList.add('border-transparent', 'text-gray-700');
                    });
                    
                    // 高亮对应的分类链接
                    const activeLink = document.querySelector(`a[href="#${currentCategory}"]`);
                    if (activeLink) {
                        activeLink.classList.remove('border-transparent', 'text-gray-700');
                        activeLink.classList.add('border-blue-500', 'bg-white', 'text-blue-600');
                    }
                }
            }, 100));
        }
        
        // 更新选中菜品数量
        function updateSelectedCount() {
            const checkboxes = document.querySelectorAll('input[name="dish_ids"]:checked');
            const countElement = document.getElementById('selected-count');
            countElement.textContent = checkboxes.length;
            
            // 根据是否有选中项，更改按钮状态
            const submitButton = countElement.closest('button');
            if (checkboxes.length > 0) {
                submitButton.classList.remove('opacity-70', 'cursor-not-allowed');
                submitButton.disabled = false;
            } else {
                submitButton.classList.add('opacity-70', 'cursor-not-allowed');
                submitButton.disabled = true;
            }
        }
        
        // 监听复选框变化，更新数量
        document.querySelectorAll('input[name="dish_ids"]').forEach(checkbox => {
            checkbox.addEventListener('change', updateSelectedCount);
        });
        
        // 初始状态
        updateSelectedCount();
        
        // 辅助函数：防抖
        function debounce(func, wait) {
            let timeout;
            return function() {
                const context = this;
                const args = arguments;
                clearTimeout(timeout);
                timeout = setTimeout(() => {
                    func.apply(context, args);
                }, wait);
            };
        }
    });
</script>
{% endblock %}
