{% extends 'base.html' %}

{% block title %}{{ dish.name }}{% endblock %}

{% block header_title %}菜品详情{% endblock %}

{% block content %}
<div class="bg-white rounded-lg shadow-md overflow-hidden mb-6">
    <div class="p-4 border-b flex justify-between items-center">
        <h1 class="text-2xl font-bold text-gray-800">{{ dish.name }}</h1>
        <div class="flex space-x-2">
            <a href="{{ url_for('dishes.index') }}" class="bg-gray-500 hover:bg-gray-600 text-white py-2 px-4 rounded shadow-sm flex items-center">
                <i class="fas fa-arrow-left mr-2"></i> 返回
            </a>
            <a href="{{ url_for('dishes.edit', id=dish.id) }}" class="bg-yellow-500 hover:bg-yellow-600 text-white py-2 px-4 rounded shadow-sm flex items-center">
                <i class="fas fa-edit mr-2"></i> 编辑
            </a>
            <button type="button" class="bg-red-500 hover:bg-red-600 text-white py-2 px-4 rounded shadow-sm flex items-center" onclick="openDeleteDialog('{{ dish.id }}')">
                <i class="fas fa-trash-alt mr-2"></i> 删除
            </button>
        </div>
    </div>

    <div class="p-4">
        <div class="flex flex-col md:flex-row">
            <div class="w-full md:w-1/3 mb-4 md:mb-0 md:mr-6">
                {% if dish.image_path %}
                    <div class="bg-gray-100 rounded overflow-hidden" style="min-height: 300px;">
                        <img 
                            src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 1 1'%3E%3C/svg%3E" 
                            data-src="{{ url_for('static', filename=dish.image_path) }}" 
                            class="lazy-image w-full h-full object-cover" 
                            alt="{{ dish.name }}" 
                            style="transition: opacity 0.3s ease-in-out; opacity: 0;">
                    </div>
                {% else %}
                    <div class="bg-gray-100 flex justify-center items-center rounded" style="min-height: 300px;">
                        <i class="fas fa-utensils text-gray-400 text-5xl"></i>
                    </div>
                {% endif %}
            </div>
            <div class="w-full md:w-2/3">
                <div class="mb-2">
                    <span class="inline-block px-2 py-1 bg-gray-200 text-gray-800 rounded-full">{{ dish.category.name }}</span>
                </div>

                <h2 class="text-xl font-semibold text-gray-800 mt-4 mb-2">配料：</h2>
                {% if dish.ingredients %}
                    <div class="bg-white border border-gray-200 rounded-lg mb-4">
                        {% for ingredient in dish.ingredients %}
                            <div class="p-3 border-b last:border-b-0 flex justify-between items-center">
                                <span class="text-gray-800">{{ ingredient.name }}</span>
                                <span class="bg-blue-100 text-blue-800 px-2 py-1 rounded-full text-sm">{{ ingredient.amount }}</span>
                            </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <p class="text-gray-500 italic mb-4">暂无配料信息</p>
                {% endif %}

                <h2 class="text-xl font-semibold text-gray-800 mb-2">烹饪方法：</h2>
                <div class="p-4 bg-gray-50 rounded-lg whitespace-pre-line">
                    {{ dish.recipe|nl2br|safe }}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 删除确认对话框 -->
<div id="deleteDialog{{ dish.id }}" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
    <div class="bg-white rounded-lg shadow-lg w-11/12 max-w-md mx-auto">
        <div class="p-4 border-b border-gray-200">
            <h3 class="text-lg font-medium text-gray-900">确认删除</h3>
        </div>
        <div class="p-4">
            <p class="text-gray-700">确定要删除菜品 "{{ dish.name }}" 吗？此操作不可恢复！</p>
        </div>
        <div class="p-4 bg-gray-50 rounded-b-lg flex justify-end space-x-3">
            <button type="button" class="bg-gray-200 hover:bg-gray-300 text-gray-800 py-2 px-4 rounded" onclick="closeDeleteDialog('{{ dish.id }}')">取消</button>
            <form action="{{ url_for('dishes.delete', id=dish.id) }}" method="post" class="m-0">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                <button type="submit" class="bg-red-500 hover:bg-red-600 text-white py-2 px-4 rounded">确定删除</button>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // 删除对话框控制
    function openDeleteDialog(id) {
        document.getElementById('deleteDialog' + id).classList.remove('hidden');
        document.body.style.overflow = 'hidden';
    }
    
    function closeDeleteDialog(id) {
        document.getElementById('deleteDialog' + id).classList.add('hidden');
        document.body.style.overflow = '';
    }
    
    // 图片懒加载
    document.addEventListener('DOMContentLoaded', function() {
        if ('IntersectionObserver' in window) {
            const lazyImages = document.querySelectorAll('.lazy-image');
            
            const imageObserver = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        const image = entry.target;
                        
                        // 开始加载图片
                        const tempImage = new Image();
                        tempImage.onload = function() {
                            image.src = image.dataset.src;
                            image.style.opacity = '1';
                            
                            // 一旦加载完成，不再需要观察
                            imageObserver.unobserve(image);
                        };
                        tempImage.src = image.dataset.src;
                    }
                });
            }, {
                rootMargin: '200px 0px',
                threshold: 0.01
            });
            
            lazyImages.forEach(image => {
                imageObserver.observe(image);
            });
        } else {
            // 回退方案：如果不支持IntersectionObserver，直接加载所有图片
            document.querySelectorAll('.lazy-image').forEach(image => {
                image.src = image.dataset.src;
                image.style.opacity = '1';
            });
        }
    });
</script>
{% endblock %}
