{% extends 'base.html' %}

{% block title %}菜品列表{% endblock %}

{% block content %}
<div class="bg-white rounded-lg shadow-md p-4 mb-6 flex justify-between items-center">
    <h1 class="text-2xl font-bold text-gray-800">
        {% if category %}
            {{ category.name }} - 菜品列表
        {% else %}
            所有菜品
        {% endif %}
    </h1>
    <div class="flex space-x-2">
        {% if category %}
            <a href="{{ url_for('categories.index') }}" class="bg-gray-500 hover:bg-gray-600 text-white py-2 px-4 rounded shadow-sm flex items-center">
                <i class="fas fa-arrow-left mr-2"></i> 返回分类
            </a>
        {% endif %}
        <a href="{{ url_for('dishes.create') }}" class="bg-blue-600 hover:bg-blue-700 text-white py-2 px-4 rounded shadow-sm flex items-center">
            <i class="fas fa-plus mr-2"></i> 新建菜品
        </a>
    </div>
</div>

{% if dishes %}
    <div class="bg-white rounded-lg shadow-md overflow-hidden">
        {% for dish in dishes %}
            <div class="p-4 border-b last:border-b-0">
                <div class="flex items-center">
                    <!-- 菜品图片 - 可点击进入详情页 -->
                    <a href="{{ url_for('dishes.view', id=dish.id) }}" class="w-24 h-24 flex-shrink-0 rounded overflow-hidden mr-4 bg-gray-100 block">
                        {% if dish.image_path %}
                            {% set image_path = dish.image_path %}
                            {% set thumb_path = image_path.replace(image_path.split('/')[-1], 'thumb_' + image_path.split('/')[-1]) %}
                            <img 
                                src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 1 1'%3E%3C/svg%3E" 
                                data-src="{{ url_for('static', filename=thumb_path) }}" 
                                alt="{{ dish.name }}" 
                                class="lazy-image w-full h-full object-cover"
                                style="opacity: 0; transition: opacity 0.3s ease-in-out;">
                        {% else %}
                            <div class="w-full h-full flex items-center justify-center">
                                <i class="fas fa-utensils text-gray-400 text-2xl"></i>
                            </div>
                        {% endif %}
                    </a>
                    
                <!-- 菜品信息 - 整个区域可点击进入详情页 -->
                <a href="{{ url_for('dishes.view', id=dish.id) }}" class="flex-grow block hover:bg-blue-50 transition duration-150">
                    <h2 class="text-xl font-medium text-gray-900">{{ dish.name }}</h2>
                    <div class="mt-1">
                        <span class="inline-block px-2 py-1 text-xs bg-gray-200 text-gray-800 rounded-full">
                            {{ dish.category.name }}
                        </span>
                        <span class="text-sm text-gray-600 ml-2">
                            配料: {{ dish.ingredients|length }} 种
                        </span>
                    </div>
                </a>
                    
                <!-- 操作按钮 - 只保留快捷查看 -->
                <div class="ml-2">
                    <a href="{{ url_for('dishes.view', id=dish.id) }}" class="bg-blue-600 hover:bg-blue-700 text-white py-2 px-4 rounded shadow-sm flex items-center">
                        <i class="fas fa-eye mr-2"></i> 查看
                    </a>
                </div>
            </div>
        {% endfor %}
    </div>
{% else %}
    <div class="bg-blue-100 border-l-4 border-blue-500 text-blue-700 p-4 rounded">
        {% if category %}
            <p>该分类下暂无菜品，请点击"新建菜品"按钮创建。</p>
        {% else %}
            <p>暂无菜品，请点击"新建菜品"按钮创建。</p>
        {% endif %}
    </div>
{% endif %}
{% endblock %}

{% block scripts %}
<script>
    // 激活懒加载
    document.addEventListener('DOMContentLoaded', function() {
        if ('IntersectionObserver' in window) {
            const lazyImages = document.querySelectorAll('.lazy-image');
            
            const imageObserver = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        const image = entry.target;
                        
                        // 开始加载图片
                        const tempImage = new Image();
                        tempImage.onload = function() {
                            image.src = image.dataset.src;
                            image.style.opacity = '1';
                            
                            // 一旦加载完成，不再需要观察
                            imageObserver.unobserve(image);
                        };
                        tempImage.src = image.dataset.src;
                    }
                });
            }, {
                rootMargin: '200px 0px',
                threshold: 0.01
            });
            
            lazyImages.forEach(image => {
                imageObserver.observe(image);
            });
        } else {
            // 回退方案：如果不支持IntersectionObserver，直接加载所有图片
            document.querySelectorAll('.lazy-image').forEach(image => {
                image.src = image.dataset.src;
                image.style.opacity = '1';
            });
        }
        
        // 添加行点击事件，整行可点击
        document.querySelectorAll('.p-4').forEach(item => {
            const linkElem = item.querySelector('a.flex-grow');
            if (linkElem) {
                const href = linkElem.getAttribute('href');
                
                // 确保点击空白区域也能导航，但排除按钮区域
                item.addEventListener('click', function(e) {
                    // 如果点击的是按钮区域或其子元素，不处理
                    if (e.target.closest('.ml-2') || e.target.closest('a') || e.target.closest('button')) {
                        return;
                    }
                    
                    // 否则，导航到详情页
                    window.location.href = href;
                });
                
                // 添加鼠标指针样式
                item.style.cursor = 'pointer';
            }
        });
    });
</script>
{% endblock %}
